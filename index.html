<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TimeCure 财务额度看板</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- 引入 Chart.js 核心库 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- 引入 Chart.js 的 datalabels 插件 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- 新增：引入 SheetJS (xlsx) 库用于导出 Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: #f0f2f5;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
    }
    .container {
      max-width: 1600px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 25px;
      margin: 25px 0;
    }
    .client-card, .add-client-card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.07);
      padding: 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      transition: all 0.3s ease;
      border: 1px solid #e8e8e8;
    }
    .client-card:hover, .add-client-card:hover {
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      transform: translateY(-5px);
    }
    .add-client-card {
      justify-content: center;
      font-size: 70px;
      color: #a0a0a0;
      cursor: pointer;
      border: 2.5px dashed #d9d9d9;
      background: #fafafa;
      min-height: 450px;
    }
    .add-client-card:hover {
       color: #0d6efd;
       border-color: #0d6efd;
       background: #f0f8ff;
    }
    .client-pie {
      width: 180px;
      height: 180px;
      margin: 20px 0;
    }
    .pie-label-container {
      width: 100%;
      text-align: center;
      margin-top: 10px;
      min-height: 50px; /* 避免没标签时布局跳动 */
    }
    .pie-label {
      display: inline-block;
      font-size: 13px;
      margin: 0 8px 5px 0;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: 500;
      color: #fff;
    }
    .client-card .client-name {
      font-size: 1.8rem;
      font-weight: 700;
      color: #1a2747;
      margin-bottom: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
     .client-card .client-name:hover {
        color: #0d6efd;
     }
    .warning-badge, .danger-badge {
        font-size: 0.8rem;
        padding: 0.2em 0.6em;
        border-radius: 0.8em;
        color: #fff;
        font-weight: 600;
    }
    .warning-badge {
        background-color: #f7b731;
    }
    .danger-badge {
        background-color: #e74c3c;
    }
    .info-row {
      font-size: 1rem;
      color: #555;
      margin-bottom: 0.5rem;
    }
    .info-row b {
      color: #000;
      font-weight: 600;
    }
    .quota-bar-wrapper {
      width: 100%;
      height: 25px;
      margin-top: 15px;
      position: relative;
    }
    .quota-bar-bg {
      width: 100%;
      height: 100%;
      background: #e9ecef;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    .quota-bar-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.6s ease-in-out;
      position: absolute;
      left: 0;
      top: 0;
    }
    .quota-bar-text {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .dashboard-title {
      font-size: 2rem;
      font-weight: 700;
      color: #1a2747;
      margin-bottom: 1rem;
    }
    .action-bar {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .modal-header {
      background: #1a2747;
      color: #fff;
    }
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
  </style>
</head>
<body>
<div class="container py-4">
  <div id="main-view">
    <h1 class="dashboard-title">客户额度总览</h1>
    <div class="action-bar">
      <button class="btn btn-primary" id="addRecordBtn">添加消费记录</button>
      <button class="btn btn-outline-secondary" id="importBtn">导入数据</button>
      <button class="btn btn-outline-secondary" id="exportBtn">导出数据</button>
      <input type="file" id="importFile" accept=".json" style="display:none;">
    </div>
    <div class="dashboard" id="dashboard">
      <!-- 客户卡片将由JS动态生成 -->
    </div>
  </div>

  <div id="detail-view" style="display: none;">
      <h1 id="detail-title" class="dashboard-title"></h1>
      <div class="action-bar">
        <button class="btn btn-secondary" id="backToDashboardBtn">返回总览</button>
        <button class="btn btn-outline-primary" id="exportClientBtn">导出JSON</button>
        <!-- 新增：导出Excel按钮 -->
        <button class="btn btn-success" id="exportExcelBtn">导出Excel</button>
      </div>
       <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>日期</th><th>分类</th><th>项目</th><th>供应商</th>
              <th>数量</th><th>单价</th><th>总额</th><th>备注</th><th>操作</th>
            </tr>
          </thead>
          <tbody id="clientCostTableBody"></tbody>
        </table>
    </div>
  </div>
</div>

<!-- 添加/编辑记录模态框 -->
<div class="modal fade" id="recordModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="recordModalTitle">添加记录</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="recordForm">
          <input type="hidden" id="recordId">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">日期</label><input type="date" class="form-control" id="recordDate" required></div>
            <div class="col-md-6"><label class="form-label">客户</label><select class="form-select" id="recordClient" required></select></div>
            <!-- 更新：分类改为带有分组的二级下拉框 -->
            <div class="col-md-6"><label class="form-label">分类</label><select class="form-select" id="recordCategory" required></select></div>
            <div class="col-md-6"><label class="form-label">项目</label><input type="text" class="form-control" id="recordItemName" placeholder="例如：第一季度补充剂" required></div>
            <div class="col-md-12"><label class="form-label">供应商</label><input type="text" class="form-control" id="recordSupplier"></div>
            <div class="col-md-4"><label class="form-label">数量</label><input type="number" class="form-control" id="recordQuantity" min="0" value="1" required></div>
            <div class="col-md-4"><label class="form-label">单价</label><input type="number" class="form-control" id="recordUnitPrice" min="0" step="0.01" required></div>
            <div class="col-md-4"><label class="form-label">总额</label><input type="number" class="form-control" id="recordTotalAmount" min="0" step="0.01" required readonly></div>
            <div class="col-md-12"><label class="form-label">备注</label><textarea class="form-control" id="recordNotes" rows="2"></textarea></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="saveRecordBtn">保存</button>
      </div>
    </div>
  </div>
</div>

<!-- 新增客户模态框 -->
<div class="modal fade" id="addClientModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新增客户</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">客户姓名</label>
            <input type="text" class="form-control" id="newClientName" placeholder="例如：张三" required>
          </div>
          <div class="mb-3">
             <label class="form-label">客户类型</label>
             <select class="form-select" id="newClientType">
                <option value="基础版">基础版 (额度: 40,000)</option>
                <option value="Pro版">Pro版 (额度: 120,000)</option>
                <option value="特殊">特殊(手动输入额度)</option>
             </select>
          </div>
          <div class="mb-3" id="manualQuotaWrapper" style="display:none;">
            <label class="form-label">总额度</label>
            <input type="number" class="form-control" id="newClientQuota" min="0" placeholder="例如：150000">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="saveNewClientBtn">保存客户</button>
      </div>
    </div>
  </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除这条记录吗？此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // =================================================================
  // 1. SUPABASE 初始化：请将下面替换为您自己的信息
  // =================================================================
  const SUPABASE_URL = 'https://qeyqclikmnjudhusnebh.supabase.co'; // 在 Supabase 的 API 设置中找到
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFleXFjbGlrbW5qdWRodXNuZWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NDc2MTMsImV4cCI6MjA3MDAyMzYxM30.2XtxEyR-D_PTkwN0_QlGSmF-A0kaiPQV06sVQALSYxk';    // 在 Supabase 的 API 设置中找到

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


  // =================================================================
  // 权威分类标准 (这部分保持不变)
  // =================================================================
  const CATEGORY_STRUCTURE = {
    "实物成本": ["定制补充剂成本", "益生菌成本", "同源性荷尔蒙成本"],
    "方案成本": ["美国长寿方案成本", "医厅方案成本", "膳食方案成本", "方案研发/更新成本", "医疗方案成本"],
    "额外采买好物成本": ["额外采买好物成本"],
    "客户服务成本": ["拜访客户差旅费", "客户招待费", "其他客户服务费用", "拜访客户成本"],
    "检测成本": ["时光尺3.0", "时光尺2.0 NAD+", "16S肠道菌群", "其他检测项目", "检测成本", "NAD+"],
    "抗衰设备成本": ["设备采购成本", "设备维护成本", "抗衰设备使用成本"],
    "提成": ["提成"],
    "其他成本": ["其他成本"]
  };
  const CATEGORY_COLORS = { "实物成本": "#ff6384", "方案成本": "#4bc0c0", "额外采买好物成本": "#ff9f40", "客户服务成本": "#c9cbcf", "检测成本": "#36a2eb", "抗衰设备成本": "#9966ff", "提成": "#ffce56", "其他成本": "#a3a3a3", "默认": "#6c757d" };
  const SUB_TO_MAIN_CATEGORY_MAP = {};
  for (const mainCat in CATEGORY_STRUCTURE) {
    CATEGORY_STRUCTURE[mainCat].forEach(subCat => { SUB_TO_MAIN_CATEGORY_MAP[subCat] = mainCat; });
  }
  const getMainCategory = (subCategory) => SUB_TO_MAIN_CATEGORY_MAP[subCategory] || '其他成本';

  // 全局变量，用于存储从数据库加载的数据
  let allClients = [];
  let allRecords = [];

  // 模态框实例
  const recordModal = new bootstrap.Modal(document.getElementById('recordModal'));
  const addClientModal = new bootstrap.Modal(document.getElementById('addClientModal'));
  const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  let recordToDelete = null;

  // =================================================================
  // 2. 数据处理函数 (已改造为 Supabase API 调用)
  // =================================================================

  const getClient = (clientId) => allClients.find(c => c.id == clientId);
  
  function getClientQuota(client) {
    if (!client) return 0;
    if (client.quota) return client.quota;
    if (client.name === '潘&徐') return 240000;
    if (client.name === '彭黎') return 150000;
    if (client.type && client.type.includes('Pro')) return 120000;
    return 40000;
  }

  const getClientSpent = (clientId) => allRecords
    .filter(r => r.client_id == clientId) // 注意: 字段名是 client_id
    .reduce((sum, r) => sum + Number(r.total_amount), 0); // 注意: 字段名是 total_amount

  const getQuotaColor = (spent, quota) => {
    const percent = quota > 0 ? spent / quota : 0;
    if (percent >= 1) return '#e74c3c';
    if (percent >= 0.6) return '#f7b731';
    return '#2e7be6';
  };
  
  // =================================================================
  // 3. 核心数据加载与渲染 (已改造为异步函数)
  // =================================================================
  async function loadAndRenderAll() {
    // 显示加载状态，例如：
    document.getElementById('dashboard').innerHTML = '<p class="text-center">正在从云端加载数据...</p>';

    const { data: clients, error: clientsError } = await supabase.from('clients').select('*').order('created_at');
    const { data: records, error: recordsError } = await supabase.from('cost_records').select('*');

    if (clientsError || recordsError) {
      console.error('加载数据失败:', clientsError || recordsError);
      alert('从云端加载数据失败，请检查网络连接或Supabase配置。');
      document.getElementById('dashboard').innerHTML = '<p class="text-center text-danger">数据加载失败！</p>';
      return;
    }

    allClients = clients;
    allRecords = records;

    renderDashboard();
    // 如果在详情页，则刷新详情页
    const detailView = document.getElementById('detail-view');
    if(detailView.style.display === 'block') {
        const clientId = document.getElementById('detail-title').dataset.clientId;
        if(clientId) {
            renderClientCostTable(clientId);
        }
    }
  }
  
  function renderDashboard() {
    const dashboard = document.getElementById('dashboard');
    dashboard.innerHTML = '';
    allClients.forEach(client => {
      const card = document.createElement('div');
      card.className = 'client-card';
      
      const quota = getClientQuota(client);
      const spent = getClientSpent(client.id);
      const remaining = quota - spent;
      const spentPercent = quota > 0 ? (spent / quota) * 100 : 0;
      const barColor = getQuotaColor(spent, quota);
      const spentRatio = quota > 0 ? spent / quota : 0;

      let alertBadge = '';
      if (spentRatio >= 1) {
          alertBadge = '<span class="danger-badge">超额</span>';
      } else if (spentRatio >= 0.6) {
          alertBadge = '<span class="warning-badge">超60%</span>';
      }

      card.innerHTML = `
        <div class="client-name" data-client-id="${client.id}">${client.name} ${alertBadge}</div>
        <div class="info-row">总额度: <b>￥${quota.toLocaleString()}</b></div>
        <div class="info-row">已花费: <b style="color: ${barColor};">￥${spent.toLocaleString()}</b></div>
        <div class="info-row">剩　余: <b style="color: #28a745;">￥${remaining.toLocaleString()}</b></div>
        <div class="client-pie"><canvas id="pie_${client.id}"></canvas></div>
        <div class="pie-label-container" id="pie_labels_${client.id}"></div>
        <div class="quota-bar-wrapper">
          <div class="quota-bar-bg">
            <div class="quota-bar-fill" style="background:${barColor}; width:${Math.min(100, spentPercent).toFixed(2)}%;"></div>
            <div class="quota-bar-text">${spentPercent.toFixed(1)}% 已用</div>
          </div>
        </div>
      `;
      dashboard.appendChild(card);
      setTimeout(() => renderPieChart(client), 0);
    });
    
    const addCard = document.createElement('div');
    addCard.className = 'add-client-card';
    addCard.innerHTML = '+';
    addCard.onclick = () => addClientModal.show();
    dashboard.appendChild(addCard);
  }

  function renderPieChart(client) {
    const ctx = document.getElementById(`pie_${client.id}`);
    if (!ctx) return;

    const records = allRecords.filter(r => r.client_id == client.id); // 注意字段名
    const mainCategoryMap = new Map();
    records.forEach(r => {
      const mainCat = getMainCategory(r.category);
      const currentTotal = mainCategoryMap.get(mainCat) || 0;
      mainCategoryMap.set(mainCat, currentTotal + Number(r.total_amount)); // 注意字段名
    });

    // ... (Pie Chart 渲染逻辑基本不变)
    const labels = [...mainCategoryMap.keys()];
    const values = [...mainCategoryMap.values()];

    if (labels.length === 0) {
        ctx.parentElement.innerHTML = '<div style="color: #999; text-align: center; margin-top: 70px;">暂无消费记录</div>';
        document.getElementById(`pie_labels_${client.id}`).innerHTML = '';
        return;
    }
    
    if (window[`pieChart_${client.id}`]) {
      window[`pieChart_${client.id}`].destroy();
    }

    window[`pieChart_${client.id}`] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: labels.map(label => CATEGORY_COLORS[label] || CATEGORY_COLORS['默认']),
          borderColor: '#fff',
          borderWidth: 3,
        }]
      },
      options: { /* ... options 不变 ... */ },
      plugins: [ChartDataLabels]
    });

    const labelContainer = document.getElementById(`pie_labels_${client.id}`);
    labelContainer.innerHTML = labels.map(label => 
        `<span class="pie-label" style="background-color: ${CATEGORY_COLORS[label] || CATEGORY_COLORS['默认']}">${label}</span>`
    ).join('');
  }

  function showClientDetail(clientId) {
    const client = getClient(clientId);
    if (!client) return;

    document.getElementById('main-view').style.display = 'none';
    document.getElementById('detail-view').style.display = 'block';
    
    const detailTitle = document.getElementById('detail-title');
    detailTitle.textContent = `${client.name} - 消费明细`;
    detailTitle.dataset.clientId = clientId; // 存储当前客户端ID
    
    document.getElementById('exportClientBtn').onclick = () => exportClientData(clientId);
    document.getElementById('exportExcelBtn').onclick = () => exportClientDataAsExcel(clientId);

    renderClientCostTable(clientId);
  }

  function hideClientDetail() {
    document.getElementById('main-view').style.display = 'block';
    document.getElementById('detail-view').style.display = 'none';
    document.getElementById('detail-title').dataset.clientId = ''; // 清除ID
    loadAndRenderAll();
  }

  function renderClientCostTable(clientId) {
    const tbody = document.getElementById('clientCostTableBody');
    tbody.innerHTML = '';
    const records = allRecords.filter(r => r.client_id == clientId);
    if (records.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center p-4">暂无记录</td></tr>`;
        return;
    }
    records.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(record => {
        tbody.appendChild(createRecordRow(record));
    });
  }
  
  function createRecordRow(record) {
      const tr = document.createElement('tr');
      // 注意使用数据库列名: item_name, unit_price, total_amount
      tr.innerHTML = `
        <td>${record.date}</td>
        <td>${record.category}</td>
        <td>${record.item_name}</td>
        <td>${record.supplier || ''}</td>
        <td>${record.quantity}</td>
        <td>￥${Number(record.unit_price).toLocaleString()}</td>
        <td>￥${Number(record.total_amount).toLocaleString()}</td>
        <td>${record.notes || ''}</td>
        <td class="table-actions">
          <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${record.id}">编辑</button>
          <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${record.id}">删除</button>
        </td>
      `;
      return tr;
  }

  // =================================================================
  // 4. 事件处理 (已改造为调用 Supabase)
  // =================================================================
  
  document.getElementById('backToDashboardBtn').onclick = hideClientDetail;

  document.getElementById('dashboard').addEventListener('click', (e) => {
      const clientNameDiv = e.target.closest('.client-name');
      if (clientNameDiv) {
          showClientDetail(clientNameDiv.dataset.clientId);
      }
  });

  document.getElementById('addRecordBtn').onclick = () => {
    document.getElementById('recordForm').reset();
    document.getElementById('recordId').value = '';
    document.getElementById('recordModalTitle').textContent = '添加记录';
    updateClientOptions();
    updateCategoryOptions();
    document.getElementById('recordDate').valueAsDate = new Date();
    recordModal.show();
  };
  
  const quantityInput = document.getElementById('recordQuantity');
  const unitPriceInput = document.getElementById('recordUnitPrice');
  quantityInput.addEventListener('input', updateRecordTotal);
  unitPriceInput.addEventListener('input', updateRecordTotal);
  function updateRecordTotal() {
      const quantity = parseFloat(quantityInput.value) || 0;
      const unitPrice = parseFloat(unitPriceInput.value) || 0;
      document.getElementById('recordTotalAmount').value = (quantity * unitPrice).toFixed(2);
  }

  document.getElementById('saveRecordBtn').onclick = async () => {
    const form = document.getElementById('recordForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const recordId = document.getElementById('recordId').value;
    // 使用数据库列名构建对象
    const recordData = {
      client_id: Number(document.getElementById('recordClient').value),
      date: document.getElementById('recordDate').value,
      category: document.getElementById('recordCategory').value,
      item_name: document.getElementById('recordItemName').value.trim(),
      supplier: document.getElementById('recordSupplier').value.trim(),
      quantity: Number(document.getElementById('recordQuantity').value),
      unit_price: Number(document.getElementById('recordUnitPrice').value),
      total_amount: Number(document.getElementById('recordTotalAmount').value),
      notes: document.getElementById('recordNotes').value.trim(),
    };

    let error;
    if (recordId) {
      // 更新现有记录
      const { error: updateError } = await supabase.from('cost_records').update(recordData).eq('id', recordId);
      error = updateError;
    } else {
      // 插入新记录
      const { error: insertError } = await supabase.from('cost_records').insert([recordData]);
      error = insertError;
    }

    if (error) {
      console.error('保存记录失败:', error);
      alert('保存失败: ' + error.message);
    } else {
      recordModal.hide();
      // 在这里我们不需要手动刷新，因为实时监听会自动处理
      // loadAndRenderAll(); // 如果没有开启实时监听，则需要这行
    }
  };

  document.body.addEventListener('click', e => {
      if (e.target.classList.contains('edit-btn')) handleEdit(e.target.dataset.id);
      if (e.target.classList.contains('delete-btn')) handleDelete(e.target.dataset.id);
  });

  function handleEdit(id) {
      const record = allRecords.find(r => r.id == id);
      if (!record) return;
      
      document.getElementById('recordForm').reset();
      updateClientOptions();
      updateCategoryOptions();

      // 使用数据库列名填充表单
      document.getElementById('recordId').value = record.id;
      document.getElementById('recordDate').value = record.date;
      document.getElementById('recordClient').value = record.client_id;
      document.getElementById('recordCategory').value = record.category;
      document.getElementById('recordItemName').value = record.item_name;
      document.getElementById('recordSupplier').value = record.supplier;
      document.getElementById('recordQuantity').value = record.quantity;
      document.getElementById('recordUnitPrice').value = record.unit_price;
      document.getElementById('recordTotalAmount').value = record.total_amount;
      document.getElementById('recordNotes').value = record.notes;
      
      document.getElementById('recordModalTitle').textContent = '编辑记录';
      recordModal.show();
  }

  function handleDelete(id) {
      recordToDelete = id;
      deleteConfirmModal.show();
  }

  document.getElementById('confirmDeleteBtn').onclick = async () => {
      if (recordToDelete) {
          const { error } = await supabase.from('cost_records').delete().eq('id', recordToDelete);
          if (error) {
            console.error('删除失败:', error);
            alert('删除失败: ' + error.message);
          } else {
            recordToDelete = null;
             // 实时监听会自动刷新，无需手动调用 loadAndRenderAll()
          }
      }
      deleteConfirmModal.hide();
  };

  document.getElementById('newClientType').addEventListener('change', (e) => {
      document.getElementById('manualQuotaWrapper').style.display = e.target.value === '特殊' ? 'block' : 'none';
  });

  document.getElementById('saveNewClientBtn').onclick = async () => {
    const name = document.getElementById('newClientName').value.trim();
    const type = document.getElementById('newClientType').value;
    let quota = null; // 在数据库中设为 null
    if (type === '特殊') {
        const quotaValue = parseFloat(document.getElementById('newClientQuota').value);
        if (isNaN(quotaValue) || quotaValue <= 0) {
            alert('请为特殊类型客户填写有效的额度！');
            return;
        }
        quota = quotaValue;
    }
    if (!name) {
      alert('请填写客户姓名！');
      return;
    }

    const { error } = await supabase.from('clients').insert([{ name, type, quota }]);

    if (error) {
        console.error('新增客户失败:', error);
        alert('新增客户失败: ' + error.message);
    } else {
        addClientModal.hide();
        document.getElementById('newClientName').value = '';
        document.getElementById('newClientQuota').value = '';
        document.getElementById('manualQuotaWrapper').style.display = 'none';
        // 实时监听会自动刷新，无需手动调用 loadAndRenderAll()
    }
  };
  
  function updateClientOptions() {
    const sel = document.getElementById('recordClient');
    const currentVal = sel.value;
    sel.innerHTML = '';
    allClients.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name;
      sel.appendChild(opt);
    });
    if(currentVal) sel.value = currentVal;
  }

  function updateCategoryOptions() {
    const sel = document.getElementById('recordCategory');
    sel.innerHTML = '';
    for (const mainCat in CATEGORY_STRUCTURE) {
        const optGroup = document.createElement('optgroup');
        optGroup.label = mainCat;
        CATEGORY_STRUCTURE[mainCat].forEach(subCat => {
            const opt = document.createElement('option');
            opt.value = subCat;
            opt.textContent = subCat;
            optGroup.appendChild(opt);
        });
        sel.appendChild(optGroup);
    }
  }

  // ... 导入/导出功能基本不变，但需要从 allClients 和 allRecords 获取数据 ...
  // 注意：原来的导入功能是覆盖所有数据，这在多人协作环境中可能是危险的，暂时移除或改造
  document.getElementById('importBtn').style.display = 'none'; // 暂时隐藏导入
  document.getElementById('exportBtn').onclick = () => {
      exportData({ clients: allClients, costRecords: allRecords }, `TimeCure_数据备份`);
  }
  // ... 其他导出函数 exportClientData, exportData, exportClientDataAsExcel 逻辑不变 ...


  // =================================================================
  // 5. 实时监听 (Supabase Realtime)
  // =================================================================
  function setupRealtimeListener() {
    const channel = supabase
      .channel('public_db_changes')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public' },
        (payload) => {
          console.log('检测到云端数据变化，正在刷新界面...', payload);
          loadAndRenderAll();
        }
      )
      .subscribe();
    
    console.log('已成功连接到 Supabase 并开启实时同步。');
  }

  // ====== 初始化 ======
  loadAndRenderAll();
  setupRealtimeListener();
});
</script>
</body>
</html>
